[SERVICE]
    # Flush
    # =====
    # Increase flush interval to allow more batching (5 seconds instead of 1)
    flush        5

    # Daemon
    # ======
    # instruct Fluent Bit to run in foreground or background mode.
    daemon       Off

    # Log_Level
    # =========
    # Set the verbosity level of the service, values can be:
    #
    # - error
    # - warning
    # - info
    # - debug
    # - trace
    #
    # by default 'info' is set, that means it includes 'error' and 'warning'.
    log_level    info

    # Parsers File
    # ============
    # specify an optional 'Parsers' configuration file
    parsers_file parsers.conf

    # Plugins File
    # ============
    # specify an optional 'Plugins' configuration file to load external plugins.
    plugins_file plugins.conf

    # HTTP Server
    # ===========
    # Enable/Disable the built-in HTTP Server for metrics
    http_server  Off
    http_listen  0.0.0.0
    http_port    2020

    # Storage
    # =======
    # Fluent Bit can use memory and filesystem buffering based mechanisms
    #
    # - https://docs.fluentbit.io/manual/administration/buffering-and-storage
    #
    # storage metrics
    # ---------------
    # publish storage pipeline metrics in '/api/v1/storage'. The metrics are
    # exported only if the 'http_server' option is enabled.
    #
    storage.metrics on

    # storage.path
    # ------------
    # Enable filesystem buffering to prevent data loss during high load
    storage.path /tmp/fluentbit-storage

    # storage.sync
    # ------------
    # Use normal mode for better performance
    storage.sync normal

    # storage.checksum
    # ----------------
    # Enable data integrity checks
    storage.checksum on

    # storage.backlog.mem_limit
    # -------------------------
    # Increase memory limit for backlog processing (50MB instead of 5MB)
    storage.backlog.mem_limit 50M

[INPUT]
    Name tail
    Path /var/logs/audit.log
    DB /tmp/logs.db
    # Increase memory buffer limit to handle bursts (50MB instead of 5MB)
    Mem_Buf_Limit 50MB
    # Skip very long lines to prevent blocking
    Skip_Long_Lines On
    Skip_Empty_Lines On
    # Add buffering to handle high throughput
    Buffer_Chunk_Size 256k
    Buffer_Max_Size 2MB
    # Refresh interval for reading the file
    Refresh_Interval 5
    # Use inotify for better performance
    Read_from_Head Off
    Parser audit_json
    # Enable storage buffering
    storage.type filesystem

[FILTER]
    Name parser
    Match *
    Key_Name log
    Parser json
    Reserve_Data On

[FILTER]
    Name grep
    Match *
    Regex channel .+

[FILTER]
    Name record_modifier
    Match *
    Record env ${LOKI_ENV}

[FILTER]
    Name modify
    Match *
    Rename tenant_uuid tenant


[FILTER]
    Name record_modifier
    Match *
    Record env ${LOKI_ENV}


[OUTPUT]
    name  stdout
    match *

[OUTPUT]
    name loki
    match *
    # Promote selected JSON fields to labels for fast filtering
    label_keys $env,$channel,$tenant
    Host loki-cp-dev.gears-int.com
    port 443
    tls on
    tls.verify on
    tenant_id erp
    # Enable compression to reduce network load (supported property)
    compress gzip
